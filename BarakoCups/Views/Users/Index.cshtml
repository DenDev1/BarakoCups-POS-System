@model IEnumerable<BarakoCups.Models.Account.Users>

@{
    ViewData["Title"] = "Index";
}

<h1 class="text-2xl font-bold mb-6">Users</h1>

<!-- 🔵 Create Button to Trigger Modal -->
<button type="button" class="btn btn-primary mb-4"
        data-bs-toggle="modal"
        data-bs-target="#userModal"
        data-url="@Url.Action("Create")">
    Create New
</button>

<!-- ✅ Users Table -->
<div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Username</th>
                <th>Password</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.FirstName</td>
                    <td>@item.LastName</td>
                    <td>@item.Email</td>
                    <td>@item.Username</td>
                    <td>@item.Password</td>
                    <td>@item.Roles?.RoleName</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#userModal"
                                data-url="@Url.Action("Edit", new { id = item.UserId })"
                                data-title="Edit User">
                            Edit
                        </button>

                        <a asp-action="Details" asp-route-id="@item.UserId" class="btn btn-sm btn-outline-success">Details</a>
                        <a asp-action="Delete" asp-route-id="@item.UserId" class="btn btn-sm btn-outline-danger">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- ✅ Bootstrap Modal (for CreateUserPartial) -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Form will load here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 🔁 Load form into modal when button clicked
            const userModal = document.getElementById('userModal');

            userModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const url = button.getAttribute('data-url');
                const modalBody = document.getElementById('modalBody');

                fetch(url)
                    .then(res => res.text())
                    .then(html => {
                        modalBody.innerHTML = html;
                    });
            });

            // ✅ Submit the form inside modal via JS
            document.addEventListener('submit', function (e) {
                const form = e.target;
                if (form && form.id === 'createUserForm') {
                    e.preventDefault();

                    const formData = new FormData(form);
                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.redirectToUrl) {
                                window.location.href = data.redirectToUrl; // redirect after save
                            } else {
                                // re-render the form if server returns validation errors
                                fetch(form.action)
                                    .then(r => r.text())
                                    .then(html => {
                                        document.getElementById('modalBody').innerHTML = html;
                                    });
                            }
                        });
                }
            });
        });
    </script>
}
